load("@rules_haskell//haskell:defs.bzl", "haskell_doc")
load("@rules_python//python:defs.bzl", "py_binary")
load("@rules_pkg//:mappings.bzl", "pkg_files", "strip_prefix")
load("@rules_pkg//:pkg.bzl", "pkg_tar")

haskell_doc(
    name = "docs",
    # Disables generating the huge multi-package ./index.
    # See: //:third_party/rules_haskell/haddock_index.patch
    index = False,
    # The deps attribute is auto-populated by buildozer via scripts/generate.
    deps = [
        "//lib/amazonka",
        "//lib/amazonka-s3-encryption",
        "//lib/amazonka-test",
        "//lib/services/amazonka-alexa-business",
        "//lib/services/amazonka-apigateway",
        "//lib/services/amazonka-apigatewaymanagementapi",
        "//lib/services/amazonka-application-autoscaling",
        "//lib/services/amazonka-appstream",
        "//lib/services/amazonka-appsync",
        "//lib/services/amazonka-athena",
        "//lib/services/amazonka-autoscaling",
        "//lib/services/amazonka-autoscaling-plans",
        "//lib/services/amazonka-batch",
        "//lib/services/amazonka-budgets",
        "//lib/services/amazonka-certificatemanager",
        "//lib/services/amazonka-certificatemanager-pca",
        "//lib/services/amazonka-cloud9",
        "//lib/services/amazonka-clouddirectory",
        "//lib/services/amazonka-cloudformation",
        "//lib/services/amazonka-cloudfront",
        "//lib/services/amazonka-cloudhsm",
        "//lib/services/amazonka-cloudhsmv2",
        "//lib/services/amazonka-cloudsearch",
        "//lib/services/amazonka-cloudsearch-domains",
        "//lib/services/amazonka-cloudtrail",
        "//lib/services/amazonka-cloudwatch",
        "//lib/services/amazonka-cloudwatch-events",
        "//lib/services/amazonka-cloudwatch-logs",
        "//lib/services/amazonka-codebuild",
        "//lib/services/amazonka-codecommit",
        "//lib/services/amazonka-codedeploy",
        "//lib/services/amazonka-codepipeline",
        "//lib/services/amazonka-codestar",
        "//lib/services/amazonka-cognito-identity",
        "//lib/services/amazonka-cognito-idp",
        "//lib/services/amazonka-cognito-sync",
        "//lib/services/amazonka-comprehend",
        "//lib/services/amazonka-config",
        "//lib/services/amazonka-connect",
        "//lib/services/amazonka-cost-explorer",
        "//lib/services/amazonka-cur",
        "//lib/services/amazonka-datapipeline",
        "//lib/services/amazonka-devicefarm",
        "//lib/services/amazonka-directconnect",
        "//lib/services/amazonka-discovery",
        "//lib/services/amazonka-dms",
        "//lib/services/amazonka-ds",
        "//lib/services/amazonka-dynamodb",
        "//lib/services/amazonka-dynamodb-dax",
        "//lib/services/amazonka-dynamodb-streams",
        "//lib/services/amazonka-ec2",
        "//lib/services/amazonka-ecr",
        "//lib/services/amazonka-ecs",
        "//lib/services/amazonka-efs",
        "//lib/services/amazonka-eks",
        "//lib/services/amazonka-elasticache",
        "//lib/services/amazonka-elasticbeanstalk",
        "//lib/services/amazonka-elasticsearch",
        "//lib/services/amazonka-elastictranscoder",
        "//lib/services/amazonka-elb",
        "//lib/services/amazonka-elbv2",
        "//lib/services/amazonka-emr",
        "//lib/services/amazonka-fms",
        "//lib/services/amazonka-gamelift",
        "//lib/services/amazonka-glacier",
        "//lib/services/amazonka-glue",
        "//lib/services/amazonka-greengrass",
        "//lib/services/amazonka-guardduty",
        "//lib/services/amazonka-health",
        "//lib/services/amazonka-iam",
        "//lib/services/amazonka-importexport",
        "//lib/services/amazonka-inspector",
        "//lib/services/amazonka-iot",
        "//lib/services/amazonka-iot-analytics",
        "//lib/services/amazonka-iot-dataplane",
        "//lib/services/amazonka-iot-jobs-dataplane",
        "//lib/services/amazonka-kinesis",
        "//lib/services/amazonka-kinesis-analytics",
        "//lib/services/amazonka-kinesis-firehose",
        "//lib/services/amazonka-kinesis-video",
        "//lib/services/amazonka-kinesis-video-archived-media",
        "//lib/services/amazonka-kinesis-video-media",
        "//lib/services/amazonka-kms",
        "//lib/services/amazonka-lambda",
        "//lib/services/amazonka-lex-models",
        "//lib/services/amazonka-lex-runtime",
        "//lib/services/amazonka-lightsail",
        "//lib/services/amazonka-marketplace-analytics",
        "//lib/services/amazonka-marketplace-entitlement",
        "//lib/services/amazonka-marketplace-metering",
        "//lib/services/amazonka-mechanicalturk",
        "//lib/services/amazonka-mediaconvert",
        "//lib/services/amazonka-medialive",
        "//lib/services/amazonka-mediapackage",
        "//lib/services/amazonka-mediastore",
        "//lib/services/amazonka-mediastore-dataplane",
        "//lib/services/amazonka-migrationhub",
        "//lib/services/amazonka-ml",
        "//lib/services/amazonka-mobile",
        "//lib/services/amazonka-mq",
        "//lib/services/amazonka-opsworks",
        "//lib/services/amazonka-opsworks-cm",
        "//lib/services/amazonka-organizations",
        "//lib/services/amazonka-pinpoint",
        "//lib/services/amazonka-polly",
        "//lib/services/amazonka-pricing",
        "//lib/services/amazonka-qldb",
        "//lib/services/amazonka-rds",
        "//lib/services/amazonka-redshift",
        "//lib/services/amazonka-rekognition",
        "//lib/services/amazonka-resourcegroups",
        "//lib/services/amazonka-resourcegroupstagging",
        "//lib/services/amazonka-route53",
        "//lib/services/amazonka-route53-autonaming",
        "//lib/services/amazonka-route53-domains",
        "//lib/services/amazonka-s3",
        "//lib/services/amazonka-sagemaker",
        "//lib/services/amazonka-sagemaker-runtime",
        "//lib/services/amazonka-sdb",
        "//lib/services/amazonka-secretsmanager",
        "//lib/services/amazonka-serverlessrepo",
        "//lib/services/amazonka-servicecatalog",
        "//lib/services/amazonka-ses",
        "//lib/services/amazonka-sesv2",
        "//lib/services/amazonka-shield",
        "//lib/services/amazonka-sms",
        "//lib/services/amazonka-snowball",
        "//lib/services/amazonka-sns",
        "//lib/services/amazonka-sqs",
        "//lib/services/amazonka-ssm",
        "//lib/services/amazonka-stepfunctions",
        "//lib/services/amazonka-storagegateway",
        "//lib/services/amazonka-sts",
        "//lib/services/amazonka-support",
        "//lib/services/amazonka-swf",
        "//lib/services/amazonka-textract",
        "//lib/services/amazonka-transcribe",
        "//lib/services/amazonka-translate",
        "//lib/services/amazonka-waf",
        "//lib/services/amazonka-waf-regional",
        "//lib/services/amazonka-workdocs",
        "//lib/services/amazonka-workmail",
        "//lib/services/amazonka-workspaces",
        "//lib/services/amazonka-xray",
    ],
)

genrule(
    name = "metadata",
    srcs = [":docs"],
    outs = ["metadata.yaml"],
    cmd = """
printf 'packages:\n' >>$(OUTS)

for dir in $(SRCS); do
  dir="$${dir##*/}"
  pkg="$${dir#libZS}"
  pkg="$${pkg#servicesZS}"
  pkg="$${pkg#*ZS}"

  if [[ $$pkg != amazonka* ]]; then
     continue
  fi

  printf '  - name: "%s"\n'  "$$pkg" >>$(OUTS)
  printf '    link: "/docs/%s"\n' "$$dir" >>$(OUTS)
done
""",
)

genrule(
    name = "index",
    srcs = [
        "templates/index.html",
        ":metadata",
    ],
    outs = ["index.html"],
    cmd = """\
$(execpath @stackage-exe//pandoc) \
  -V path_prefix=/ \
  -f markdown \
  -t html \
  -s \
  --template=$(execpath :templates/index.html) \
  --metadata=title:"Amazonka" \
  --metadata-file=$(execpath :metadata) \
  -o $(OUTS)
""",
    tools = ["@stackage-exe//pandoc"],
)

pkg_files(
    name = "stylesheets",
    srcs = glob(["stylesheets/*.css"]),
    strip_prefix = strip_prefix.from_pkg(),
)

pkg_files(
    name = "fonts",
    srcs = glob(["fonts/*.woff"]),
    strip_prefix = strip_prefix.from_pkg(),
)

pkg_files(
    name = "package_docs",
    srcs = [
        ":docs",
    ],
    prefix = "",
    strip_prefix = strip_prefix.from_pkg(),
)

pkg_tar(
    name = "bundle",
    srcs = [
        "CNAME",
        ":fonts",
        ":index",
        ":package_docs",
        ":stylesheets",
    ],
)

py_binary(
    name = "serve",
    srcs = ["serve.py"],
    args = ["$(rootpath :bundle)"],
    data = [":bundle"],
)
